# vi: ft=sh

dotenv_if_exists .env
# Load agent-specific API keys
dotenv_if_exists .env.agent_apis
#Add other .env here

# Personal overlay, put your customized env here
source_env_if_exists .envrc.local

export DIRENV_WARN_TIMEOUT=20s
eval "$(devenv direnvrc)"

# Determine top-level directory name
topdir="$(basename "$(dirname "$PWD")")"

if [ "$topdir" = "codex" ] || [ "$topdir" = "agent" ] || [ "$topdir" = "opencode" ]; then
  export AGENT=1
  export DEV_USING_CODEX=1
  export DEVENV_PROFILE=agent
  # strip auth when in agent mode
  # TODO use ssh deploy keys to protect branches
  unset SSH_AUTH_SOCK
  export GIT_ASKPASS=/bin/false
  export GIT_SSH_COMMAND='ssh -o BatchMode=yes -o IdentitiesOnly=yes -i /dev/null'
else
  export DEVENV_PROFILE=dev
fi

# The use_devenv function supports passing flags to the devenv command
# For example: use devenv --impure --option services.postgres.enable:bool true
use devenv --profile "$DEVENV_PROFILE"
